<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/WEBSOCKET_CONNECTION_GUIDE.md">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/WEBSOCKET_CONNECTION_GUIDE.md" />
              <option name="updatedContent" value="#  WebSocket Connection Guide cho Frontend&#10;&#10;## ✅ Đã sửa các vấn đề sau:&#10;&#10;1. ✅ Thêm `/queue` vào SimpleBroker trong WebSocketConfig&#10;2. ✅ Thêm `setUserDestinationPrefix(&quot;/user&quot;)` để hỗ trợ user-specific messages&#10;3. ✅ Thêm SockJS fallback cho trình duyệt không hỗ trợ WebSocket&#10;4. ✅ Sửa path `/queue/notifications/` (thêm dấu `/` thiếu)&#10;5. ✅ Enable Redis tracking bằng cách push userId vào Redis khi join waiting list&#10;&#10;---&#10;&#10;##  Frontend Connection (JavaScript)&#10;&#10;### 1. Cài đặt thư viện:&#10;```bash&#10;npm install sockjs-client stompjs&#10;# hoặc&#10;npm install @stomp/stompjs sockjs-client&#10;```&#10;&#10;### 2. Kết nối WebSocket:&#10;&#10;```javascript&#10;import SockJS from 'sockjs-client';&#10;import { Client } from '@stomp/stompjs';&#10;&#10;const userId = 'USER123'; // ID của user hiện tại&#10;const postId = 'POST456';  // ID của charging post&#10;&#10;// Tạo WebSocket connection&#10;const socket = new SockJS('http://localhost:8080/ws');&#10;const stompClient = new Client({&#10;    webSocketFactory: () =&gt; socket,&#10;    debug: (str) =&gt; {&#10;        console.log('STOMP: ' + str);&#10;    },&#10;    reconnectDelay: 5000,&#10;    heartbeatIncoming: 4000,&#10;    heartbeatOutgoing: 4000,&#10;});&#10;&#10;stompClient.onConnect = (frame) =&gt; {&#10;    console.log('✅ Connected to WebSocket:', frame);&#10;    &#10;    // Subscribe để nhận thông báo cá nhân&#10;    stompClient.subscribe(`/user/queue/notifications/${postId}`, (message) =&gt; {&#10;        console.log(' Received notification:', message.body);&#10;        // Hiển thị notification cho user&#10;        alert(message.body);&#10;    });&#10;    &#10;    // Subscribe topic chung (broadcast cho tất cả)&#10;    stompClient.subscribe(`/topic/waiting/${postId}`, (message) =&gt; {&#10;        console.log(' Broadcast message:', message.body);&#10;    });&#10;};&#10;&#10;stompClient.onStompError = (frame) =&gt; {&#10;    console.error('❌ Broker error:', frame.headers['message']);&#10;    console.error('Details:', frame.body);&#10;};&#10;&#10;// Kết nối&#10;stompClient.activate();&#10;&#10;// Disconnect khi component unmount&#10;function disconnect() {&#10;    if (stompClient) {&#10;        stompClient.deactivate();&#10;        console.log('Disconnected');&#10;    }&#10;}&#10;```&#10;&#10;---&#10;&#10;##  React Example&#10;&#10;```jsx&#10;import React, { useEffect, useState } from 'react';&#10;import SockJS from 'sockjs-client';&#10;import { Client } from '@stomp/stompjs';&#10;&#10;function WaitingListComponent({ userId, postId }) {&#10;    const [messages, setMessages] = useState([]);&#10;    const [stompClient, setStompClient] = useState(null);&#10;&#10;    useEffect(() =&gt; {&#10;        // Khởi tạo WebSocket connection&#10;        const socket = new SockJS('http://localhost:8080/ws');&#10;        const client = new Client({&#10;            webSocketFactory: () =&gt; socket,&#10;            onConnect: () =&gt; {&#10;                console.log('✅ Connected');&#10;                &#10;                // Subscribe nhận thông báo vị trí&#10;                client.subscribe(`/user/queue/notifications/${postId}`, (message) =&gt; {&#10;                    setMessages(prev =&gt; [...prev, message.body]);&#10;                });&#10;            },&#10;            onStompError: (error) =&gt; {&#10;                console.error('❌ WebSocket error:', error);&#10;            }&#10;        });&#10;&#10;        client.activate();&#10;        setStompClient(client);&#10;&#10;        // Cleanup khi component unmount&#10;        return () =&gt; {&#10;            if (client) {&#10;                client.deactivate();&#10;            }&#10;        };&#10;    }, [userId, postId]);&#10;&#10;    return (&#10;        &lt;div&gt;&#10;            &lt;h2&gt;Waiting List Notifications&lt;/h2&gt;&#10;            &lt;ul&gt;&#10;                {messages.map((msg, idx) =&gt; (&#10;                    &lt;li key={idx}&gt;{msg}&lt;/li&gt;&#10;                ))}&#10;            &lt;/ul&gt;&#10;        &lt;/div&gt;&#10;    );&#10;}&#10;&#10;export default WaitingListComponent;&#10;```&#10;&#10;---&#10;&#10;##  Test WebSocket Connection&#10;&#10;### 1. Test bằng Browser Console:&#10;&#10;```javascript&#10;// Mở console trình duyệt (F12) và chạy:&#10;const socket = new SockJS('http://localhost:8080/ws');&#10;socket.onopen = () =&gt; console.log('✅ SockJS connected');&#10;socket.onerror = (e) =&gt; console.error('❌ SockJS error:', e);&#10;```&#10;&#10;### 2. Test bằng Postman:&#10;- Chọn **WebSocket Request**&#10;- URL: `ws://localhost:8080/ws`&#10;- Send CONNECT frame:&#10;```&#10;CONNECT&#10;accept-version:1.1,1.0&#10;heart-beat:10000,10000&#10;&#10;^@&#10;```&#10;&#10;- Subscribe:&#10;```&#10;SUBSCRIBE&#10;id:sub-0&#10;destination:/user/queue/notifications/POST123&#10;&#10;^@&#10;```&#10;&#10;---&#10;&#10;##  API Endpoints để trigger WebSocket&#10;&#10;### 1. Join Waiting List (gọi từ FE):&#10;```javascript&#10;fetch('http://localhost:8080/api/waiting-list/add/POST123', {&#10;    method: 'POST',&#10;    headers: {&#10;        'Content-Type': 'application/json',&#10;        'Authorization': 'Bearer YOUR_JWT_TOKEN'&#10;    }&#10;})&#10;.then(response =&gt; response.text())&#10;.then(data =&gt; console.log('Joined:', data));&#10;```&#10;&#10;### 2. Cancel Waiting List:&#10;```javascript&#10;fetch('http://localhost:8080/api/waiting-list/cancel/WAITING123', {&#10;    method: 'POST',&#10;    headers: {&#10;        'Authorization': 'Bearer YOUR_JWT_TOKEN'&#10;    }&#10;})&#10;.then(response =&gt; response.text())&#10;.then(data =&gt; console.log('Cancelled:', data));&#10;```&#10;&#10;---&#10;&#10;##  Destinations &amp; Topics&#10;&#10;### User-specific (chỉ user đó nhận):&#10;```&#10;/user/queue/notifications/{postId}&#10;```&#10;- Backend gửi: `simpMessagingTemplate.convertAndSendToUser(userId, &quot;/queue/notifications/&quot; + postId, message)`&#10;- Frontend subscribe: `/user/queue/notifications/${postId}`&#10;&#10;### Broadcast (tất cả client subscribe sẽ nhận):&#10;```&#10;/topic/waiting/{postId}&#10;```&#10;- Backend gửi: `simpMessagingTemplate.convertAndSend(&quot;/topic/waiting/&quot; + postId, message)`&#10;- Frontend subscribe: `/topic/waiting/${postId}`&#10;&#10;---&#10;&#10;## ⚠️ Troubleshooting&#10;&#10;### FE không nhận được message?&#10;1. ✅ Kiểm tra BE đã start chưa: `http://localhost:8080`&#10;2. ✅ Kiểm tra console có log &quot;Connected&quot; không&#10;3. ✅ Kiểm tra userId có đúng không (phải match với userId trong DB)&#10;4. ✅ Kiểm tra postId có đúng không&#10;5. ✅ Kiểm tra CORS: BE phải cho phép origin của FE&#10;&#10;### Connection bị reject?&#10;- Kiểm tra Security config có cho phép `/ws` endpoint không&#10;- Thêm vào SecurityConfig:&#10;```java&#10;.authorizeHttpRequests(auth -&gt; auth&#10;    .requestMatchers(&quot;/ws/**&quot;).permitAll()&#10;    // ...&#10;)&#10;```&#10;&#10;### Message không gửi được?&#10;- Kiểm tra BE console có log error không&#10;- Kiểm tra userId có tồn tại trong DB không&#10;- Kiểm tra Redis có running không: `redis-cli ping`&#10;&#10;---&#10;&#10;##  Flow hoàn chỉnh:&#10;&#10;```&#10;1. FE connect WebSocket → ws://localhost:8080/ws&#10;2. FE subscribe → /user/queue/notifications/{postId}&#10;3. FE gọi API → POST /api/waiting-list/add/{postId}&#10;4. BE lưu vào DB + Redis&#10;5. BE gửi WebSocket message → convertAndSendToUser(userId, &quot;/queue/notifications/&quot; + postId, ...)&#10;6. FE nhận message qua subscription&#10;7. FE hiển thị notification cho user&#10;```&#10;&#10;---&#10;&#10;##  Next Steps:&#10;&#10;- [ ] Test connection bằng browser console&#10;- [ ] Implement trong React/Vue component&#10;- [ ] Test join/cancel waiting list&#10;- [ ] Test nhận position updates&#10;- [ ] Handle reconnection khi mất kết nối&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/websocket-test.html">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/websocket-test.html" />
              <option name="updatedContent" value="&lt;!DOCTYPE html&gt;&#10;&lt;html lang=&quot;en&quot;&gt;&#10;&lt;head&gt;&#10;    &lt;meta charset=&quot;UTF-8&quot;&gt;&#10;    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;&#10;    &lt;title&gt;WebSocket Test - Waiting List&lt;/title&gt;&#10;    &lt;style&gt;&#10;        body {&#10;            font-family: Arial, sans-serif;&#10;            max-width: 800px;&#10;            margin: 50px auto;&#10;            padding: 20px;&#10;            background: #f5f5f5;&#10;        }&#10;        .container {&#10;            background: white;&#10;            padding: 30px;&#10;            border-radius: 10px;&#10;            box-shadow: 0 2px 10px rgba(0,0,0,0.1);&#10;        }&#10;        h1 {&#10;            color: #333;&#10;        }&#10;        .status {&#10;            padding: 10px;&#10;            margin: 10px 0;&#10;            border-radius: 5px;&#10;            font-weight: bold;&#10;        }&#10;        .connected {&#10;            background: #d4edda;&#10;            color: #155724;&#10;        }&#10;        .disconnected {&#10;            background: #f8d7da;&#10;            color: #721c24;&#10;        }&#10;        .input-group {&#10;            margin: 15px 0;&#10;        }&#10;        label {&#10;            display: block;&#10;            margin-bottom: 5px;&#10;            font-weight: bold;&#10;        }&#10;        input {&#10;            width: 100%;&#10;            padding: 10px;&#10;            border: 1px solid #ddd;&#10;            border-radius: 5px;&#10;            box-sizing: border-box;&#10;        }&#10;        button {&#10;            background: #007bff;&#10;            color: white;&#10;            padding: 10px 20px;&#10;            border: none;&#10;            border-radius: 5px;&#10;            cursor: pointer;&#10;            margin: 5px;&#10;        }&#10;        button:hover {&#10;            background: #0056b3;&#10;        }&#10;        button:disabled {&#10;            background: #ccc;&#10;            cursor: not-allowed;&#10;        }&#10;        .danger {&#10;            background: #dc3545;&#10;        }&#10;        .danger:hover {&#10;            background: #c82333;&#10;        }&#10;        .messages {&#10;            margin-top: 20px;&#10;            max-height: 300px;&#10;            overflow-y: auto;&#10;            border: 1px solid #ddd;&#10;            padding: 10px;&#10;            border-radius: 5px;&#10;            background: #f9f9f9;&#10;        }&#10;        .message {&#10;            padding: 8px;&#10;            margin: 5px 0;&#10;            border-radius: 3px;&#10;            background: #e3f2fd;&#10;            border-left: 3px solid #2196F3;&#10;        }&#10;        .error-message {&#10;            background: #ffebee;&#10;            border-left-color: #f44336;&#10;        }&#10;        .timestamp {&#10;            font-size: 0.85em;&#10;            color: #666;&#10;        }&#10;    &lt;/style&gt;&#10;&lt;/head&gt;&#10;&lt;body&gt;&#10;    &lt;div class=&quot;container&quot;&gt;&#10;        &lt;h1&gt; WebSocket Test - Waiting List&lt;/h1&gt;&#10;        &#10;        &lt;div id=&quot;status&quot; class=&quot;status disconnected&quot;&gt;❌ Disconnected&lt;/div&gt;&#10;        &#10;        &lt;div class=&quot;input-group&quot;&gt;&#10;            &lt;label&gt;WebSocket URL:&lt;/label&gt;&#10;            &lt;input type=&quot;text&quot; id=&quot;wsUrl&quot; value=&quot;http://localhost:8080/ws&quot; /&gt;&#10;        &lt;/div&gt;&#10;        &#10;        &lt;div class=&quot;input-group&quot;&gt;&#10;            &lt;label&gt;User ID:&lt;/label&gt;&#10;            &lt;input type=&quot;text&quot; id=&quot;userId&quot; value=&quot;USER123&quot; placeholder=&quot;Enter your user ID&quot; /&gt;&#10;        &lt;/div&gt;&#10;        &#10;        &lt;div class=&quot;input-group&quot;&gt;&#10;            &lt;label&gt;Charging Post ID:&lt;/label&gt;&#10;            &lt;input type=&quot;text&quot; id=&quot;postId&quot; value=&quot;POST456&quot; placeholder=&quot;Enter charging post ID&quot; /&gt;&#10;        &lt;/div&gt;&#10;        &#10;        &lt;div&gt;&#10;            &lt;button id=&quot;connectBtn&quot; onclick=&quot;connect()&quot;&gt;Connect&lt;/button&gt;&#10;            &lt;button id=&quot;disconnectBtn&quot; onclick=&quot;disconnect()&quot; disabled&gt;Disconnect&lt;/button&gt;&#10;            &lt;button onclick=&quot;clearMessages()&quot;&gt;Clear Messages&lt;/button&gt;&#10;        &lt;/div&gt;&#10;        &#10;        &lt;div&gt;&#10;            &lt;button onclick=&quot;subscribeNotifications()&quot;&gt;Subscribe Notifications&lt;/button&gt;&#10;            &lt;button onclick=&quot;subscribeTopic()&quot;&gt;Subscribe Topic&lt;/button&gt;&#10;            &lt;button class=&quot;danger&quot; onclick=&quot;testAddWaitingList()&quot;&gt;Test: Add to Waiting List&lt;/button&gt;&#10;        &lt;/div&gt;&#10;        &#10;        &lt;h3&gt; Messages:&lt;/h3&gt;&#10;        &lt;div id=&quot;messages&quot; class=&quot;messages&quot;&gt;&lt;/div&gt;&#10;    &lt;/div&gt;&#10;&#10;    &lt;script src=&quot;https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js&quot;&gt;&lt;/script&gt;&#10;    &lt;script src=&quot;https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js&quot;&gt;&lt;/script&gt;&#10;    &#10;    &lt;script&gt;&#10;        let stompClient = null;&#10;        let socket = null;&#10;&#10;        function setStatus(connected) {&#10;            const statusDiv = document.getElementById('status');&#10;            const connectBtn = document.getElementById('connectBtn');&#10;            const disconnectBtn = document.getElementById('disconnectBtn');&#10;            &#10;            if (connected) {&#10;                statusDiv.className = 'status connected';&#10;                statusDiv.innerHTML = '✅ Connected';&#10;                connectBtn.disabled = true;&#10;                disconnectBtn.disabled = false;&#10;            } else {&#10;                statusDiv.className = 'status disconnected';&#10;                statusDiv.innerHTML = '❌ Disconnected';&#10;                connectBtn.disabled = false;&#10;                disconnectBtn.disabled = true;&#10;            }&#10;        }&#10;&#10;        function addMessage(message, isError = false) {&#10;            const messagesDiv = document.getElementById('messages');&#10;            const messageDiv = document.createElement('div');&#10;            messageDiv.className = isError ? 'message error-message' : 'message';&#10;            &#10;            const timestamp = new Date().toLocaleTimeString();&#10;            messageDiv.innerHTML = `&#10;                &lt;span class=&quot;timestamp&quot;&gt;[${timestamp}]&lt;/span&gt;&lt;br/&gt;&#10;                ${message}&#10;            `;&#10;            &#10;            messagesDiv.appendChild(messageDiv);&#10;            messagesDiv.scrollTop = messagesDiv.scrollHeight;&#10;        }&#10;&#10;        function connect() {&#10;            const wsUrl = document.getElementById('wsUrl').value;&#10;            &#10;            addMessage(' Connecting to ' + wsUrl + '...');&#10;            &#10;            socket = new SockJS(wsUrl);&#10;            stompClient = Stomp.over(socket);&#10;            &#10;            stompClient.debug = function(str) {&#10;                console.log('STOMP: ' + str);&#10;            };&#10;            &#10;            stompClient.connect({}, function(frame) {&#10;                setStatus(true);&#10;                addMessage('✅ Connected successfully!&lt;br/&gt;Frame: ' + frame);&#10;                console.log('Connected:', frame);&#10;            }, function(error) {&#10;                setStatus(false);&#10;                addMessage('❌ Connection error: ' + error, true);&#10;                console.error('Connection error:', error);&#10;            });&#10;            &#10;            socket.onclose = function() {&#10;                setStatus(false);&#10;                addMessage('❌ WebSocket closed', true);&#10;            };&#10;        }&#10;&#10;        function disconnect() {&#10;            if (stompClient !== null) {&#10;                stompClient.disconnect();&#10;                setStatus(false);&#10;                addMessage(' Disconnected');&#10;            }&#10;        }&#10;&#10;        function subscribeNotifications() {&#10;            if (stompClient === null || !stompClient.connected) {&#10;                addMessage('❌ Please connect first!', true);&#10;                return;&#10;            }&#10;            &#10;            const userId = document.getElementById('userId').value;&#10;            const postId = document.getElementById('postId').value;&#10;            &#10;            if (!userId || !postId) {&#10;                addMessage('❌ Please enter User ID and Post ID!', true);&#10;                return;&#10;            }&#10;            &#10;            const destination = `/user/queue/notifications/${postId}`;&#10;            &#10;            stompClient.subscribe(destination, function(message) {&#10;                addMessage(' &lt;strong&gt;Notification received:&lt;/strong&gt;&lt;br/&gt;' + message.body);&#10;                console.log('Notification:', message.body);&#10;            });&#10;            &#10;            addMessage('✅ Subscribed to: ' + destination);&#10;        }&#10;&#10;        function subscribeTopic() {&#10;            if (stompClient === null || !stompClient.connected) {&#10;                addMessage('❌ Please connect first!', true);&#10;                return;&#10;            }&#10;            &#10;            const postId = document.getElementById('postId').value;&#10;            &#10;            if (!postId) {&#10;                addMessage('❌ Please enter Post ID!', true);&#10;                return;&#10;            }&#10;            &#10;            const destination = `/topic/waiting/${postId}`;&#10;            &#10;            stompClient.subscribe(destination, function(message) {&#10;                addMessage(' &lt;strong&gt;Topic message:&lt;/strong&gt;&lt;br/&gt;' + message.body);&#10;                console.log('Topic message:', message.body);&#10;            });&#10;            &#10;            addMessage('✅ Subscribed to: ' + destination);&#10;        }&#10;&#10;        function testAddWaitingList() {&#10;            const postId = document.getElementById('postId').value;&#10;            &#10;            if (!postId) {&#10;                addMessage('❌ Please enter Post ID!', true);&#10;                return;&#10;            }&#10;            &#10;            addMessage(' Calling API: POST /api/waiting-list/add/' + postId);&#10;            &#10;            fetch(`http://localhost:8080/api/waiting-list/add/${postId}`, {&#10;                method: 'POST',&#10;                headers: {&#10;                    'Content-Type': 'application/json'&#10;                }&#10;            })&#10;            .then(response =&gt; response.text())&#10;            .then(data =&gt; {&#10;                addMessage('✅ API Response: ' + data);&#10;            })&#10;            .catch(error =&gt; {&#10;                addMessage('❌ API Error: ' + error, true);&#10;            });&#10;        }&#10;&#10;        function clearMessages() {&#10;            document.getElementById('messages').innerHTML = '';&#10;        }&#10;&#10;        // Auto connect on page load&#10;        window.onload = function() {&#10;            addMessage(' Welcome! Click &quot;Connect&quot; to start testing WebSocket.');&#10;        };&#10;    &lt;/script&gt;&#10;&lt;/body&gt;&#10;&lt;/html&gt;&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>